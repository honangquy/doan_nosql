{% extends 'admin/layout.html' %}

{% block title %}T·∫°o Chuy·∫øn Xe{% endblock %}

{% block styles %}
<style>
.create-trip-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 2rem 0;
}

.trip-form-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    overflow: hidden;
    max-width: 1200px;
    margin: 0 auto;
    border: none;
}

.trip-form-header {
    background: #2196F3;
    color: white;
    padding: 3rem 2rem;
    text-align: center;
    position: relative;
}

.trip-form-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
    opacity: 0.1;
}

.trip-form-header h2 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
    text-shadow: 0 4px 8px rgba(0,0,0,0.2);
    position: relative;
    z-index: 1;
}

.trip-form-header .subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
    margin-top: 0.5rem;
    position: relative;
    z-index: 1;
}

.trip-form-body {
    padding: 3rem;
}

.form-section {
    margin-bottom: 2.5rem;
    padding: 2rem;
    background: #ffffff;
    border-radius: 15px;
    border: none;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
}

.form-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: #2196F3;
}

.form-section-title {
    color: #2196F3;
    font-weight: 700;
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-section-title i {
    margin-right: 0.75rem;
    font-size: 1.5rem;
    color: #4facfe;
    -webkit-text-fill-color: #4facfe;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-control, .form-select {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 0.875rem 1.25rem;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    background: #ffffff;
}

.form-control:focus, .form-select:focus {
    border-color: #4facfe;
    box-shadow: 0 0 0 0.25rem rgba(79, 172, 254, 0.15), 0 8px 25px rgba(79, 172, 254, 0.1);
    outline: none;
    transform: translateY(-1px);
}

.form-label .required {
    color: #e74c3c;
    margin-left: 0.25rem;
}

/* Buttons Styling */
.btn-create-trip {
    background: #2196F3;
    border: none;
    color: white;
    padding: 1rem 3rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 50px;
    box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 1px;
    width: 100%;
    margin-top: 2rem;
}

.btn-create-trip:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(33, 150, 243, 0.6);
    background: #1976D2;
}

.btn-create-trip:active {
    transform: translateY(-1px);
}

.btn-secondary-custom {
    background: #6c757d;
    border: none;
    color: white;
    padding: 0.75rem 2rem;
    font-weight: 500;
    border-radius: 25px;
    box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
    transition: all 0.3s ease;
}

.btn-secondary-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
}

/* Vehicle Select Styling */
.form-select#vehicleSelect {
    background-color: #ffffff;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}

.form-select#vehicleSelect option {
    padding: 12px 16px !important;
    margin: 2px 0 !important;
    border-radius: 6px !important;
    font-size: 14px;
    line-height: 1.4;
    transition: all 0.2s ease;
}

/* Xe ph√π h·ª£p - m√†u xanh ƒë·∫≠m */
.form-select#vehicleSelect option[data-available="true"] {
    background: linear-gradient(135deg, #d1f2eb, #a7f3d0) !important;
    color: #065f46 !important;
    font-weight: bold !important;
    border: 2px solid #10b981 !important;
}

/* Xe kh√¥ng ph√π h·ª£p - m√†u x√°m nh·∫°t */
.form-select#vehicleSelect option[data-available="false"] {
    background: linear-gradient(135deg, #f9fafb, #f3f4f6) !important;
    color: #9ca3af !important;
    font-weight: normal !important;
    border: 1px solid #e5e7eb !important;
}

/* Header option */
.form-select#vehicleSelect option[value=""] {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
    color: #1e40af !important;
    font-weight: bold !important;
    font-style: italic;
}

/* Checkbox Group Styling */
.stops-container {
    background: #ffffff;
    border-radius: 15px;
    padding: 2rem;
    margin-top: 1rem;
    border: 1px solid #e9ecef;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 0.75rem;
    max-height: 350px;
    overflow-y: auto;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.checkbox-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: white;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.checkbox-item:hover {
    background: #2196F3;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
}

.checkbox-item input[type="checkbox"] {
    margin-right: 0.75rem;
    transform: scale(1.3);
    accent-color: #4facfe;
}

/* Info Cards */
.info-alert {
    background: #2196F3;
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: none;
    box-shadow: 0 8px 25px rgba(116, 185, 255, 0.3);
}

.info-alert .bi {
    font-size: 1.5rem;
    margin-right: 0.75rem;
}

/* Animations cho UI feedback */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* Responsive Design */
@media (max-width: 768px) {
    .trip-form-body {
        padding: 2rem 1.5rem;
    }
    
    .trip-form-header h2 {
        font-size: 2rem;
    }
    
    .checkbox-group {
        grid-template-columns: 1fr;
        max-height: 250px;
    }
    
    .btn-create-trip {
        padding: 0.875rem 2rem;
        font-size: 1rem;
    }
}

.form-control, .form-select {
    padding: 0.75rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #2196F3;
    box-shadow: 0 0 0 3px rgba(33,150,243,0.1);
    outline: none;
}

.btn-create-trip {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 1rem;
}

.btn-create-trip:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76,175,80,0.3);
}

.btn-cancel {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 20px;
    margin-right: 1rem;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.btn-cancel:hover {
    background: #5a6268;
    color: white;
    text-decoration: none;
}

.stops-container {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    background: white;
}

.stop-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 6px;
}

.stop-item input[type="checkbox"] {
    margin-right: 0.5rem;
    transform: scale(1.2);
}

.time-input-group {
    display: flex;
    gap: 1rem;
}

.status-select {
    background-color: white;
}

@media (max-width: 768px) {
    .trip-form-body {
        padding: 1rem;
    }
    
    .form-section {
        padding: 1rem;
    }
    
    .time-input-group {
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="create-trip-container">
    <div class="container">
        <div class="trip-form-card">
            <div class="trip-form-header">
                <h2><i class="bi bi-bus-front me-3"></i>T·∫°o Chuy·∫øn Xe M·ªõi</h2>
                <p class="subtitle mb-0">T·∫°o l·ªãch tr√¨nh chuy·∫øn xe v·ªõi th√¥ng tin chi ti·∫øt v√† chuy√™n nghi·ªáp</p>
            </div>
            
            <div class="trip-form-body">
                <!-- Info Alert -->
                <div class="info-alert">
                    <i class="bi bi-info-circle-fill"></i>
                    <strong>H∆∞·ªõng d·∫´n t·∫°o chuy·∫øn xe:</strong> 
                    Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o m√£ chuy·∫øn v√† thi·∫øt l·∫≠p gh·∫ø cho xe ƒë∆∞·ª£c ch·ªçn.
                </div>
                
                <form method="POST" id="createTripForm" data-ajax="false">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-info-circle"></i>
                            Th√¥ng Tin C∆° B·∫£n
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        M√£ L·ªãch Tr√¨nh <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" name="maLichTrinh" id="maLichTrinh"
                                           value="{{ next_trip_id }}" readonly 
                                           placeholder="T·ª± ƒë·ªông t·∫°o">
                                    <small class="text-muted">M√£ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        Ch·ªçn Tuy·∫øn ƒê∆∞·ªùng <span class="required">*</span>
                                    </label>
                                    <select class="form-select" name="maTuyenDuong" id="routeSelect" onchange="updateRouteInfo()" required>
                                        <option value="">-- Ch·ªçn tuy·∫øn ƒë∆∞·ªùng --</option>
                                        {% for route in routes %}
                                        <option value="{{ route.maTuyenDuong }}" 
                                                data-start="{{ route.diemDau }}"
                                                data-end="{{ route.diemCuoi }}"
                                                data-distance="{{ route.doDai or '' }}"
                                                data-duration="{{ route.thoiGianDi or '' }}"
                                                data-name="{{ route.tenTuyenDuong }}">
                                            {{ route.tenTuyenDuong }} ({{ route.diemDau }} ‚Üí {{ route.diemCuoi }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Selection -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-bus-front"></i>
                            Ch·ªçn Xe Khach
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label">
                                        Ch·ªçn Xe <span class="required">*</span>
                                    </label>
                                    <select class="form-select" name="maXe" id="vehicleSelect" onchange="updateVehicleInfo()" required>
                                        <option value="">-- Ch·ªçn xe ch·∫°y tuy·∫øn --</option>
                                        {% for vehicle in vehicles %}
                                        <option value="{{ vehicle.maXeKhach }}" 
                                                data-route="{{ vehicle.tuyen }}"
                                                data-plate="{{ vehicle.bienSo }}"
                                                data-type="{{ vehicle.maLoai }}"
                                                data-brand="{{ vehicle.maHang }}">
                                            {{ vehicle.ten }} ({{ vehicle.bienSo }}) - Tuy·∫øn: {{ vehicle.tuyen }} - Lo·∫°i: {{ vehicle.maLoai }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Ch·ªçn xe ph√π h·ª£p v·ªõi tuy·∫øn ƒë√£ ch·ªçn</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Route Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-geo-alt"></i>
                            Th√¥ng Tin Tuy·∫øn ƒê∆∞·ªùng
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        ƒêi·ªÉm ƒêi <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" name="diemDi" id="diemDi" readonly 
                                           placeholder="S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn sau khi ch·ªçn tuy·∫øn" value="">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        ƒêi·ªÉm ƒê·∫øn <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" name="diemDen" id="diemDen" readonly 
                                           placeholder="S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn sau khi ch·ªçn tuy·∫øn" value="">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-geo"></i> Tr·∫°m D·ª´ng (Ch·ªçn nhi·ªÅu)
                            </label>
                            <div class="stops-container">
                                {% for stop in stops %}
                                <div class="stop-item">
                                    <input type="checkbox" name="tramDung" value="{{ stop.maTramDung }}" 
                                           id="stop{{ loop.index }}">
                                    <label for="stop{{ loop.index }}">
                                        {{ stop.tenTramDung }} - {{ stop.diaChi }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-calendar-event"></i>
                            Th√¥ng Tin L·ªãch Tr√¨nh
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        Ng√†y ƒêi <span class="required">*</span>
                                    </label>
                                    <input type="date" class="form-control" name="ngayDi" id="ngayDi"
                                           min="{{ today }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        Gi·ªù ƒêi <span class="required">*</span>
                                    </label>
                                    <input type="time" class="form-control" name="gioDi" id="gioDi" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Staff Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-people"></i>
                            Th√¥ng Tin Nh√¢n Vi√™n
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        T√™n T√†i X·∫ø <span class="required">*</span>
                                    </label>
                                    <select class="form-select" name="tenTaiXe" required>
                                        <option value="">-- Ch·ªçn t√†i x·∫ø --</option>
                                        {% for driver in drivers %}
                                        <option value="{{ driver.ten }}">
                                            {{ driver.ten }} - {{ driver.chucVu or 'Nh√¢n vi√™n' }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        T√™n Ph·ª• Xe
                                    </label>
                                    <select class="form-select" name="tenPhuXe">
                                        <option value="">-- Ch·ªçn ph·ª• xe (t√πy ch·ªçn) --</option>
                                        {% for driver in drivers %}
                                        <option value="{{ driver.ten }}">
                                            {{ driver.ten }} - {{ driver.chucVu or 'Nh√¢n vi√™n' }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="bi bi-gear"></i>
                            Th√¥ng Tin B·ªï Sung
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        Tr·∫°ng Th√°i
                                    </label>
                                    <select class="form-select status-select" name="tinhTrang">
                                        <option value="Ch∆∞a kh·ªüi h√†nh" selected>Ch∆∞a kh·ªüi h√†nh</option>
                                        <option value="ƒêang ch·ªù">ƒêang ch·ªù</option>
                                        <option value="S·∫µn s√†ng">S·∫µn s√†ng</option>
                                        <option value="ƒê√£ kh·ªüi h√†nh">ƒê√£ kh·ªüi h√†nh</option>
                                        <option value="ƒê√£ ho√†n th√†nh">ƒê√£ ho√†n th√†nh</option>
                                        <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                M√¥ T·∫£ / Ghi Ch√∫
                            </label>
                            <textarea class="form-control" name="moTa" rows="3" 
                                      placeholder="Ghi ch√∫ v·ªÅ chuy·∫øn xe..."></textarea>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions text-center">
                        <div class="row">
                            <div class="col-md-3">
                                <a href="{{ url_for('admin.trip_list') }}" class="btn btn-secondary-custom w-100">
                                    <i class="bi bi-arrow-left me-2"></i>Quay L·∫°i
                                </a>
                            </div>
                            <div class="col-md-9">
                                <button type="submit" class="btn btn-create-trip" id="submitBtn">
                                    <i class="bi bi-plus-circle me-2"></i>T·∫°o Chuy·∫øn Xe M·ªõi
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Route selection handler - C·∫¨P NH·∫¨T V·ªöI API M·ªöI
    window.updateRouteInfo = function() {
        console.log('=== updateRouteInfo called ===');
        
        const routeSelect = document.getElementById('routeSelect');
        if (!routeSelect) {
            console.error('routeSelect not found');
            return;
        }
        
        const selectedOption = routeSelect.options[routeSelect.selectedIndex];
        console.log('Selected route option:', selectedOption);
        
        if (selectedOption && selectedOption.value) {
            const routeId = selectedOption.value;
            console.log('Loading route info for:', routeId);
            
            // Hi·ªán th·ªã loading indicator
            showLoadingIndicator('T·∫£i th√¥ng tin tuy·∫øn...');
            
            // G·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin tuy·∫øn
            console.log('üîç API Call URL:', `/admin/api/route-info/${routeId}`);
            
            fetch(`/admin/api/route-info/${routeId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'  // Include session cookies
            })
            .then(response => {
                console.log('‚úÖ API response status:', response.status);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('‚ùå API Error Response:', text);
                        throw new Error(`API Error ${response.status}: ${text.substring(0, 200)}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Route API data received:', data);
                hideLoadingIndicator();
                
                // Auto-fill ƒëi·ªÉm ƒëi v√† ƒëi·ªÉm ƒë·∫øn theo logic mapping c·ªßa danh s√°ch chuy·∫øn xe
                const diemDiInput = document.getElementById('diemDi');
                const diemDenInput = document.getElementById('diemDen');
                
                if (diemDiInput && diemDenInput && data.diemDau && data.diemCuoi) {
                    // Mapping: TuyenDuong.diemDau -> LichTrinh.diemDi
                    diemDiInput.value = data.diemDau;
                    // Mapping: TuyenDuong.diemCuoi -> LichTrinh.diemDen
                    diemDenInput.value = data.diemCuoi;
                    
                    console.log('Auto-filled locations:', {
                        diemDi: data.diemDau,
                        diemDen: data.diemCuoi
                    });
                    
                    // Visual feedback - Hi·ªáu ·ª©ng m√†u xanh
                    [diemDiInput, diemDenInput].forEach(input => {
                        input.style.cssText = `
                            background: linear-gradient(135deg, #10b981, #059669) !important;
                            color: white !important;
                            border: 3px solid #059669 !important;
                            font-weight: bold !important;
                            transform: scale(1.02);
                            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
                        `;
                    });
                    
                    // Reset styling sau 3 gi√¢y
                    setTimeout(() => {
                        [diemDiInput, diemDenInput].forEach(input => {
                            input.style.cssText = '';
                        });
                    }, 3000);
                    
                    // Hi·ªán th·ªã th√¥ng b√°o th√†nh c√¥ng
                    showSuccessMessage(`‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn: ${data.diemDau} ‚Üí ${data.diemCuoi}`);
                }
                
                // L·ªçc xe ph√π h·ª£p v·ªõi tuy·∫øn
                if (data.matching_vehicles && data.matching_vehicles.length > 0) {
                    filterVehiclesByRouteData(data.matching_vehicles, data.tenTuyenDuong);
                } else {
                    console.warn('No matching vehicles found for route:', data.tenTuyenDuong);
                    resetVehicleOptions();
                }
                
            })
            .catch(error => {
                console.error('Error loading route info:', error);
                hideLoadingIndicator();
                
                // Check for specific authentication error
                if (error.message.includes('401') || error.message.includes('Authentication required')) {
                    showErrorMessage('üîí L·ªói x√°c th·ª±c: Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i l√†m Admin');
                    setTimeout(() => {
                        window.location.href = '/admin/dashboard';
                    }, 3000);
                } else {
                    showErrorMessage('‚ùå L·ªói t·∫£i th√¥ng tin tuy·∫øn: ' + error.message);
                }
            });
            
        } else {
            console.log('No route selected, clearing fields');
            // X√≥a d·ªØ li·ªáu khi kh√¥ng ch·ªçn tuy·∫øn
            ['diemDi', 'diemDen'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });
            
            resetVehicleOptions();
        }
    }
    
    // Vehicle selection handler - Global function
    window.updateVehicleInfo = function() {
        console.log('updateVehicleInfo called');
        
        const vehicleSelect = document.getElementById('vehicleSelect');
        if (!vehicleSelect) {
            console.error('vehicleSelect not found');
            return;
        }
        
        const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
        
        if (selectedOption && selectedOption.value) {
            console.log('Selected vehicle:', selectedOption.value);
            console.log('Vehicle route:', selectedOption.getAttribute('data-route'));
            console.log('Vehicle type:', selectedOption.getAttribute('data-type'));
            
            // Visual feedback for vehicle selection
            selectedOption.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                selectedOption.style.backgroundColor = '';
            }, 1500);
        }
    }
    
    // H√†m l·ªçc xe d·ª±a tr√™n d·ªØ li·ªáu API - S·ª¨ D·ª§NG LOGIC MAPPING ƒê√öNG
    function filterVehiclesByRouteData(matchingVehicles, routeName) {
        const vehicleSelect = document.getElementById('vehicleSelect');
        
        if (!matchingVehicles || matchingVehicles.length === 0) {
            resetVehicleOptions();
            return;
        }
        
        console.log('Filtering vehicles by API data:', {
            routeName: routeName,
            matchingCount: matchingVehicles.length
        });
        
        // T·∫°o danh s√°ch m√£ xe ph√π h·ª£p
        const matchingVehicleIds = new Set(matchingVehicles.map(v => v.maXeKhach));
        let actualMatchingCount = 0;
        
        // √Åp d·ª•ng style cho t·∫•t c·∫£ c√°c option
        Array.from(vehicleSelect.options).forEach(option => {
            if (option.value && option.value !== '') {
                const vehicleId = option.value;
                const isMatching = matchingVehicleIds.has(vehicleId);
                
                if (isMatching) {
                    // XE PH√ô H·ª¢P - M√ÄU XANH R·ª∞C R·ª†!
                    option.style.cssText = `
                        background: linear-gradient(135deg, #059669, #047857) !important;
                        color: white !important;
                        font-weight: bold !important;
                        font-size: 15px !important;
                        padding: 12px 16px !important;
                        border-radius: 8px !important;
                        margin: 4px 0 !important;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
                        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4) !important;
                        border: 3px solid #047857 !important;
                        text-transform: uppercase !important;
                        letter-spacing: 0.5px !important;
                    `;
                    actualMatchingCount++;
                    console.log(`‚úÖ MATCHING: ${option.textContent}`);
                } else {
                    // XE KH√îNG PH√ô H·ª¢P - M√ÄU XANH NH·∫†T
                    option.style.cssText = `
                        background: linear-gradient(135deg, #f0f9ff, #e0f2fe) !important;
                        color: #0369a1 !important;
                        font-weight: normal !important;
                        font-size: 13px !important;
                        padding: 8px 12px !important;
                        border-radius: 4px !important;
                        margin: 2px 0 !important;
                        opacity: 0.75 !important;
                        border: 1px solid #bae6fd !important;
                        font-style: italic !important;
                    `;
                    console.log(`üîµ NON-MATCHING: ${option.textContent}`);
                }
            }
        });
        
        // C·∫≠p nh·∫≠t header option v·ªõi th√¥ng tin r√µ r√†ng
        const firstOption = vehicleSelect.querySelector('option[value=""]');
        if (firstOption) {
            if (actualMatchingCount > 0) {
                firstOption.textContent = `‚úÖ Ch·ªçn xe xanh ph√π h·ª£p (${actualMatchingCount} xe)`;
                firstOption.style.cssText = `
                    background: linear-gradient(135deg, #1d4ed8, #1e40af) !important;
                    color: white !important;
                    font-weight: bold !important;
                    font-size: 16px !important;
                    padding: 15px !important;
                    text-align: center !important;
                    text-transform: uppercase !important;
                    letter-spacing: 1px !important;
                `;
            } else {
                firstOption.textContent = '‚ö†Ô∏è Kh√¥ng c√≥ xe ph√π h·ª£p - Ki·ªÉm tra l·∫°i tuy·∫øn';
                firstOption.style.cssText = `
                    background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
                    color: white !important;
                    font-weight: bold !important;
                    font-size: 14px !important;
                    padding: 12px !important;
                    text-align: center !important;
                `;
            }
        }
        
        // Hi·ªán th·ªã th√¥ng b√°o k·∫øt qu·∫£
        if (actualMatchingCount > 0) {
            showSuccessMessage(`üöó T√¨m th·∫•y ${actualMatchingCount} xe xanh ph√π h·ª£p tuy·∫øn: ${routeName}`);
        } else {
            showWarningMessage(`‚ö†Ô∏è Kh√¥ng c√≥ xe n√†o ph√π h·ª£p v·ªõi tuy·∫øn: ${routeName}`);
        }
        
        console.log(`Found ${actualMatchingCount} matching vehicles for route: ${routeName}`);
    }
    
    // FALLBACK: Filter vehicles based on selected route option (for compatibility)
    function filterVehiclesByRoute(selectedRouteOption) {
        console.log('Using fallback filterVehiclesByRoute');
        
        if (!selectedRouteOption || !selectedRouteOption.value) {
            resetVehicleOptions();
            return;
        }
        
        const routeId = selectedRouteOption.value;
        const routeName = selectedRouteOption.getAttribute('data-name') || selectedRouteOption.textContent;
        
        // G·ªçi API ƒë·ªÉ l·∫•y d·ªØ li·ªáu xe ph√π h·ª£p
        fetch(`/admin/api/route-info/${routeId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'  // Include session cookies
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.matching_vehicles) {
                filterVehiclesByRouteData(data.matching_vehicles, routeName);
            } else {
                console.warn('No matching vehicles in API response');
                resetVehicleOptions();
            }
        })
        .catch(error => {
            console.error('Error in fallback filter:', error);
            showErrorMessage('‚ùå L·ªói t·∫£i d·ªØ li·ªáu xe: ' + error.message);
            resetVehicleOptions();
        });
    }
    
    // Extract route pattern helper function
    function extractRoutePattern(routeText) {
        if (!routeText) return null;
        
        // Common patterns: HCM-DL, TP.HCM-ƒê√† L·∫°t, etc.
        const patterns = {
            'hcm': /tp\.?hcm|ho chi minh|s√†i g√≤n/i,
            'dl': /ƒë√† l·∫°t|da lat|l√¢m ƒë·ªìng/i,
            'ct': /c·∫ßn th∆°|can tho/i,
            'vt': /v≈©ng t√†u|vung tau/i,
            'nt': /nha trang/i,
            'dn': /ƒë√† n·∫µng|da nang/i,
            'ag': /an giang/i,
            'cm': /c√† mau|ca mau/i
        };
        
        for (const [code, pattern] of Object.entries(patterns)) {
            if (pattern.test(routeText)) {
                return code;
            }
        }
        
        return null;
    }
    
    // Enhanced keyword extraction for better matching
    function extractEnhancedKeywords(text) {
        if (!text) return [];
        
        const normalized = text.toLowerCase()
            .replace(/tp\.?/g, '')  // Remove "TP."
            .replace(/[.,\-\s]+/g, ' ')  // Normalize separators
            .trim();
            
        const keywords = normalized.split(/\s+/).filter(k => k.length > 1);
        
        // Add common abbreviations
        const abbreviations = {
            'hcm': ['ho chi minh', 'sai gon', 'saigon'],
            'ct': ['can tho'],
            'ag': ['an giang'],
            'cm': ['ca mau'],
            'dl': ['da lat'],
            'vt': ['vung tau'],
            'dn': ['da nang']
        };
        
        const expanded = [...keywords];
        keywords.forEach(keyword => {
            if (abbreviations[keyword]) {
                expanded.push(...abbreviations[keyword]);
            }
            
            // Reverse lookup
            Object.entries(abbreviations).forEach(([abbr, full]) => {
                if (full.some(f => f.includes(keyword))) {
                    expanded.push(abbr);
                }
            });
        });
        
        return expanded;
    }
    
    // Reset vehicle options styling
    function resetVehicleOptions() {
        const vehicleSelect = document.getElementById('vehicleSelect');
        Array.from(vehicleSelect.options).forEach(option => {
            // Reset t·∫•t c·∫£ styling
            option.style.cssText = '';
        });
        
        // Reset header option
        const firstOption = vehicleSelect.querySelector('option[value=""]');
        if (firstOption) {
            firstOption.textContent = '-- Ch·ªçn xe ch·∫°y tuy·∫øn --';
            firstOption.style.cssText = '';
        }
        
        console.log('Vehicle options reset');
    }
    
    // UI Feedback Functions - TH√äM C√ÅC H√ÄM M·ªöI
    function showLoadingIndicator(message) {
        // T·∫°o ho·∫∑c c·∫≠p nh·∫≠t loading indicator
        let indicator = document.getElementById('loading-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'loading-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                font-weight: bold;
                animation: pulse 2s infinite;
            `;
            document.body.appendChild(indicator);
        }
        indicator.textContent = '‚åõ ' + message;
        indicator.style.display = 'block';
    }
    
    function hideLoadingIndicator() {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }
    
    function showSuccessMessage(message) {
        showToast(message, 'success');
    }
    
    function showErrorMessage(message) {
        showToast(message, 'error');
    }
    
    function showWarningMessage(message) {
        showToast(message, 'warning');
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            max-width: 400px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        `;
        
        // M√†u theo lo·∫°i th√¥ng b√°o
        const colors = {
            success: 'linear-gradient(135deg, #10b981, #059669)',
            error: 'linear-gradient(135deg, #ef4444, #dc2626)',
            warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
            info: 'linear-gradient(135deg, #3b82f6, #1d4ed8)'
        };
        
        toast.style.background = colors[type] || colors.info;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // T·ª± ƒë·ªông ·∫©n sau 4 gi√¢y
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 4000);
    }

    // Initialize form function
    function initializeForm() {
        // Auto-generate trip ID
        const maLichTrinhInput = document.querySelector('input[name="maLichTrinh"]');
        
        const generateTripId = () => {
            const now = new Date();
            // Use timestamp for uniqueness
            const timestamp = now.getTime();
            // Add random suffix for extra uniqueness
            const randomSuffix = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `LT${timestamp}${randomSuffix}`;
        };
    
        // Always generate new ID when page loads (force refresh)
        if (maLichTrinhInput) {
            console.log('üîç Current trip ID field value:', maLichTrinhInput.value);
            const newTripId = generateTripId();
            maLichTrinhInput.value = newTripId;
            console.log('üÜï Generated new trip ID:', newTripId);
            console.log('‚úÖ Updated field value to:', maLichTrinhInput.value);
            
            // Add regenerate button if not exists
            if (!document.getElementById('regenTripBtn')) {
                const regenBtn = document.createElement('button');
                regenBtn.id = 'regenTripBtn';
                regenBtn.type = 'button';
                regenBtn.className = 'btn btn-outline-secondary btn-sm ms-2';
                regenBtn.innerHTML = 'üîÑ T·∫°o m·ªõi';
                regenBtn.title = 'T·∫°o m√£ l·ªãch tr√¨nh m·ªõi';
                
                regenBtn.addEventListener('click', function() {
                    const newId = generateTripId();
                    maLichTrinhInput.value = newId;
                    console.log('üîÑ Regenerated trip ID:', newId);
                    
                    // Show success message
                    showToast('ƒê√£ t·∫°o m√£ l·ªãch tr√¨nh m·ªõi: ' + newId, 'success');
                });
                
                // Insert button after input
                const inputGroup = maLichTrinhInput.parentNode;
                if (inputGroup.classList.contains('input-group')) {
                    inputGroup.appendChild(regenBtn);
                } else {
                    // Wrap in input group if not already
                    const wrapper = document.createElement('div');
                    wrapper.className = 'input-group';
                    maLichTrinhInput.parentNode.insertBefore(wrapper, maLichTrinhInput);
                    wrapper.appendChild(maLichTrinhInput);
                    wrapper.appendChild(regenBtn);
                }
            }
        }
        
        // Update route info when vehicle is selected
        const vehicleSelect = document.querySelector('select[name="maXe"]');
        if (vehicleSelect) {
            vehicleSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    const route = selectedOption.getAttribute('data-route');
                    console.log('Selected vehicle route:', route);
                }
            });
        }
    }
    
    // Set minimum date to today code - wrapped in DOMContentLoaded
    function initAdditionalFeatures() {
        // Set minimum date to today
        const ngayDiInput = document.querySelector('input[name="ngayDi"]');
        if (ngayDiInput) {
            const today = new Date().toISOString().split('T')[0];
            ngayDiInput.value = today;
        }
        
        // Form validation
        const form = document.getElementById('createTripForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                const requiredFields = ['maLichTrinh', 'maXe', 'diemDi', 'diemDen', 'gioDi', 'ngayDi'];
                let isValid = true;
                
                requiredFields.forEach(field => {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input && !input.value.trim()) {
                        input.style.borderColor = '#e74c3c';
                        isValid = false;
                    } else if (input) {
                        input.style.borderColor = '#e9ecef';
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                }
            });
        }
        
        // Smooth animations
        const formSections = document.querySelectorAll('.form-section');
        formSections.forEach((section, index) => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                section.style.transition = 'all 0.5s ease';
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }
    
    // ENHANCED ERROR HANDLING AND RETRY MECHANISM
    
    // Global error handler with user notification
    window.addEventListener('error', function(e) {
        console.error('JavaScript Error:', e.error);
        console.error('File:', e.filename, 'Line:', e.lineno);
        
        // Show user-friendly error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'alert alert-warning alert-dismissible fade show';
        errorMsg.style.position = 'fixed';
        errorMsg.style.top = '20px';
        errorMsg.style.right = '20px';
        errorMsg.style.zIndex = '9999';
        errorMsg.innerHTML = `
            <strong>‚ö†Ô∏è L·ªói JavaScript:</strong> M·ªôt s·ªë t√≠nh nƒÉng c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông. 
            <button class="btn btn-sm btn-outline-warning ms-2" onclick="location.reload()">
                üîÑ Refresh trang
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(errorMsg);
        
        // Auto remove after 10 seconds
        setTimeout(() => {
            if (errorMsg.parentNode) {
                errorMsg.remove();
            }
        }, 10000);
    });
    
    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled Promise Rejection:', e.reason);
        
        // Show user notification for data loading errors
        if (e.reason && e.reason.message && e.reason.message.includes('fetch')) {
            showDataLoadingError('L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!');
        }
    });
    
    // Function to show data loading errors
    function showDataLoadingError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.style.position = 'fixed';
        errorDiv.style.top = '80px';
        errorDiv.style.right = '20px';
        errorDiv.style.zIndex = '9999';
        errorDiv.style.maxWidth = '400px';
        errorDiv.innerHTML = `
            <strong>‚ùå ${message}</strong><br>
            <small>C√≥ th·ªÉ do:</small>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                <li>K·∫øt n·ªëi m·∫°ng ch·∫≠m</li>
                <li>Server ƒëang b·∫≠n</li>
                <li>Cache browser c≈©</li>
            </ul>
            <button class="btn btn-sm btn-danger" onclick="location.reload()">
                üîÑ Refresh ngay
            </button>
            <button class="btn btn-sm btn-outline-danger ms-1" onclick="this.closest('.alert').remove()">
                ‚úï ƒê√≥ng
            </button>
        `;
        
        document.body.appendChild(errorDiv);
        
        // Auto remove after 15 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 15000);
    }
    
    // Enhanced form submission with error handling
    function handleFormSubmission() {
        const form = document.getElementById('createTripForm');
        const submitBtn = document.getElementById('submitBtn');
        
        if (form && submitBtn) {
            form.addEventListener('submit', function(e) {
                try {
                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>ƒêang l∆∞u...';
                    
                    // Add timeout protection
                    const timeoutId = setTimeout(() => {
                        if (submitBtn.disabled) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>T·∫°o Chuy·∫øn Xe M·ªõi';
                            showDataLoadingError('Qu√° th·ªùi gian ch·ªù. Vui l√≤ng th·ª≠ l·∫°i!');
                        }
                    }, 30000); // 30 second timeout
                    
                    // Clear timeout when page unloads (successful submission)
                    window.addEventListener('beforeunload', () => clearTimeout(timeoutId));
                    
                } catch (error) {
                    console.error('Form submission setup error:', error);
                    e.preventDefault();
                    showDataLoadingError('L·ªói chu·∫©n b·ªã form. Vui l√≤ng refresh trang!');
                }
            });
        }
    }
    
    // Prevent form double submission with enhanced error handling
    window.preventDoubleSubmit = function() {
        const form = document.getElementById('createTripForm');
        const submitBtn = document.getElementById('submitBtn');
        
        if (form && submitBtn) {
            form.addEventListener('submit', function(e) {
                // Disable submit button to prevent double submission
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>\u0110ang t\u1ea1o...';
                
                // Re-enable after delay (fallback)
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>T\u1ea1o Chuy\u1ebfn Xe M\u1edbi';
                }, 5000);
            });
        }
    };
    
    // Check authentication status on page load
    function checkAuthenticationStatus() {
        return fetch('/admin/dashboard', {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                console.log('‚úÖ Authentication verified');
                return true;
            } else if (response.status === 302 || response.status === 401 || response.status === 403) {
                console.warn('‚ùå Authentication failed');
                showErrorMessage('üîí Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. ƒêang chuy·ªÉn h∆∞·ªõng...');
                setTimeout(() => {
                    window.location.href = '/admin/dashboard';
                }, 2000);
                return false;
            }
            return true;
        })
        .catch(error => {
            console.warn('Authentication check failed:', error);
            return true; // Continue anyway
        });
    }

    // Initialize form when DOM is loaded with enhanced error handling
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Check authentication first
            checkAuthenticationStatus().then(isAuthenticated => {
                if (isAuthenticated) {
                    initializeForm();
                    initAdditionalFeatures();
                    preventDoubleSubmit();
                    handleFormSubmission();
                    console.log('‚úÖ Create trip form initialized successfully');
                    
                    // Show success message for initialization
                    const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success alert-dismissible fade show';
            successDiv.style.position = 'fixed';
            successDiv.style.bottom = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '9999';
            successDiv.innerHTML = `
                <strong>‚úÖ Form ƒë√£ s·∫µn s√†ng!</strong> 
                B·∫°n c√≥ th·ªÉ t·∫°o chuy·∫øn xe m·ªõi.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(successDiv);
            
            // Auto remove after 3 seconds
                    setTimeout(() => {
                        if (successDiv.parentNode) {
                            successDiv.remove();
                        }
                    }, 3000);
                    
                } else {
                    console.log('‚ùå Authentication failed, skipping form initialization');
                }
            });
            
        } catch (error) {
            console.error('‚ùå Error initializing form:', error);
            showDataLoadingError('L·ªói kh·ªüi t·∫°o form. Vui l√≤ng refresh trang!');
        }
    });
</script>
{% endblock %}