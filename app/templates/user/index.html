{% extends 'base.html' %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="hero-content fade-in-up">
                    <h1 class="hero-title">
                        ƒê·∫∑t v√© xe kh√°ch<br>
                        <span class="text-accent-yellow">d·ªÖ d√†ng ‚Äî nhanh ch√≥ng ‚Äî ti·ªán l·ª£i</span>
                    </h1>
                    <p class="hero-subtitle">
                        H·ªá th·ªëng ƒë·∫∑t v√© xe kh√°ch online h√†ng ƒë·∫ßu Vi·ªát Nam. 
                        T√¨m ki·∫øm v√† ƒë·∫∑t v√© ch·ªâ trong v√†i ph√∫t v·ªõi gi√° t·ªët nh·∫•t.
                    </p>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="hero-image text-center">
                    <img src="https://via.placeholder.com/500x300/003B95/FFFFFF?text=XE+KH√ÅCH" 
                         alt="Xe Kh√°ch" class="img-fluid">
                </div>
            </div>
        </div>
        
        <!-- Search Box -->
        <div class="search-container">
            <div class="search-box">
                <form action="{{ url_for('user.search') }}" method="GET">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <div class="search-input-group">
                                <label for="diem_di">
                                    <i class="bi bi-geo-alt"></i> ƒêi·ªÉm ƒëi
                                </label>
                                <select class="form-select" name="diem_di" id="diem_di">
                                    <option value="">Ch·ªçn ƒëi·ªÉm ƒëi...</option>
                                    <option value="MƒêM">TP. H·ªì Ch√≠ Minh (Mi·ªÅn ƒê√¥ng)</option>
                                    <option value="VPQ1">TP. H·ªì Ch√≠ Minh (Qu·∫≠n 1)</option>
                                    <option value="VPBinhTan">TP. H·ªì Ch√≠ Minh (B√¨nh T√¢n)</option>
                                    <option value="BXCT">C·∫ßn Th∆°</option>
                                    <option value="VPDL">ƒê√† L·∫°t</option>
                                    <option value="BXVT">V≈©ng T√†u</option>
                                    <option value="VPAG">An Giang</option>
                                    <option value="BXCM">C√† Mau</option>
                                    <option value="VPKH">Nha Trang</option>
                                    <option value="VPTN">T√¢y Ninh</option>
                                    <option value="VPVL">Vƒ©nh Long</option>
                                    <option value="VPTD">ƒê·ªìng Th√°p</option>
                                    <option value="VPQN">Quy Nh∆°n</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6">
                            <div class="search-input-group">
                                <label for="diem_den">
                                    <i class="bi bi-geo-alt-fill"></i> ƒêi·ªÉm ƒë·∫øn
                                </label>
                                <select class="form-select" name="diem_den" id="diem_den">
                                    <option value="">Ch·ªçn ƒëi·ªÉm ƒë·∫øn...</option>
                                    <option value="MƒêM">TP. H·ªì Ch√≠ Minh (Mi·ªÅn ƒê√¥ng)</option>
                                    <option value="VPQ1">TP. H·ªì Ch√≠ Minh (Qu·∫≠n 1)</option>
                                    <option value="VPBinhTan">TP. H·ªì Ch√≠ Minh (B√¨nh T√¢n)</option>
                                    <option value="BXCT">C·∫ßn Th∆°</option>
                                    <option value="VPDL">ƒê√† L·∫°t</option>
                                    <option value="BXVT">V≈©ng T√†u</option>
                                    <option value="VPAG">An Giang</option>
                                    <option value="BXCM">C√† Mau</option>
                                    <option value="VPKH">Nha Trang</option>
                                    <option value="VPTN">T√¢y Ninh</option>
                                    <option value="VPVL">Vƒ©nh Long</option>
                                    <option value="VPTD">ƒê·ªìng Th√°p</option>
                                    <option value="VPQN">Quy Nh∆°n</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-lg-2 col-md-6">
                            <div class="search-input-group">
                                <label for="ngay_di">
                                    <i class="bi bi-calendar"></i> Ng√†y ƒëi
                                </label>
                                <input type="text" class="form-control" name="ngay_di" id="ngay_di" 
                                       placeholder="Ch·ªçn ng√†y..." readonly>
                            </div>
                        </div>
                        
                        <div class="col-lg-2 col-md-6">
                            <div class="search-input-group">
                                <label for="so_khach">
                                    <i class="bi bi-people"></i> S·ªë kh√°ch
                                </label>
                                <select class="form-select" name="so_khach" id="so_khach">
                                    <option value="1">1 ng∆∞·ªùi</option>
                                    <option value="2">2 ng∆∞·ªùi</option>
                                    <option value="3">3 ng∆∞·ªùi</option>
                                    <option value="4">4 ng∆∞·ªùi</option>
                                    <option value="5">5+ ng∆∞·ªùi</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-lg-2 col-md-12">
                            <div class="search-input-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="search-btn">
                                    <i class="bi bi-search"></i> T√¨m chuy·∫øn
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="features-section">
    <div class="container">
        <h2 class="section-title">T·∫°i sao ch·ªçn XeKhach.com?</h2>
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <h4 class="feature-title">ƒê·∫∑t v√© 24/7</h4>
                    <p class="feature-description">
                        H·ªá th·ªëng ho·∫°t ƒë·ªông 24/7, cho ph√©p b·∫°n ƒë·∫∑t v√© b·∫•t c·ª© l√∫c n√†o, 
                        ·ªü b·∫•t c·ª© ƒë√¢u ch·ªâ v·ªõi v√†i thao t√°c ƒë∆°n gi·∫£n.
                    </p>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <h4 class="feature-title">An to√†n & Tin c·∫≠y</h4>
                    <p class="feature-description">
                        Th√¥ng tin c√° nh√¢n v√† thanh to√°n ƒë∆∞·ª£c b·∫£o m·∫≠t t·ªëi ƒëa. 
                        ƒê·ªëi t√°c v·ªõi c√°c nh√† xe uy t√≠n tr√™n to√†n qu·ªëc.
                    </p>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-currency-exchange"></i>
                    </div>
                    <h4 class="feature-title">Gi√° t·ªët nh·∫•t</h4>
                    <p class="feature-description">
                        So s√°nh gi√° t·ª´ nhi·ªÅu nh√† xe kh√°c nhau, ƒë·∫£m b·∫£o b·∫°n 
                        lu√¥n c√≥ ƒë∆∞·ª£c m·ª©c gi√° t·ªët nh·∫•t cho chuy·∫øn ƒëi.
                    </p>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-headset"></i>
                    </div>
                    <h4 class="feature-title">H·ªó tr·ª£ 24/7</h4>
                    <p class="feature-description">
                        ƒê·ªôi ng≈© chƒÉm s√≥c kh√°ch h√†ng chuy√™n nghi·ªáp, s·∫µn s√†ng 
                        h·ªó tr·ª£ b·∫°n m·ªçi l√∫c qua hotline v√† chat online.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Popular Routes Section -->
<section class="routes-section">
    <div class="container">
        <h2 class="section-title">Tuy·∫øn ƒë∆∞·ªùng ph·ªï bi·∫øn</h2>
        <div class="row">
            {% for td in tuyen_duong[:8] %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="route-card">
                    <div class="route-image">
                        <i class="bi bi-bus-front"></i>
                    </div>
                    <div class="route-content">
                        <h5 class="route-title">{{ td.tenTuyenDuong }}</h5>
                        <div class="route-info">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="bi bi-geo-alt"></i> {{ td.diemDau }}</span>
                                <span><i class="bi bi-arrow-right"></i></span>
                                <span><i class="bi bi-geo-alt-fill"></i> {{ td.diemCuoi }}</span>
                            </div>
                            <div class="text-muted">
                                <i class="bi bi-clock"></i> {{ td.thoiGianDi }} gi·ªù
                                <span class="ms-3">
                                    <i class="bi bi-speedometer2"></i> {{ td.doDai }} km
                                </span>
                            </div>
                        </div>
                        <div class="route-price">
                            T·ª´ 250.000ƒë
                        </div>
                        <a href="{{ url_for('user.search', tuyen_duong=td._id) }}" 
                           class="btn btn-primary w-100">
                            <i class="bi bi-ticket"></i> Xem l·ªãch tr√¨nh
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- News Section -->
{% if tin_tuc %}
<section class="features-section">
    <div class="container">
        <div class="row align-items-center mb-4">
            <div class="col">
                <h2 class="section-title mb-0">Tin t·ª©c m·ªõi nh·∫•t</h2>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('user.news') }}" class="btn btn-outline-primary">
                    Xem t·∫•t c·∫£ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
        
        <div class="row">
            {% for tin in tin_tuc[:3] %}
            <div class="col-md-4 mb-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-newspaper"></i>
                    </div>
                    <h5 class="feature-title">{{ tin.tieuDe[:50] }}...</h5>
                    <p class="feature-description">
                        {{ tin.noiDung[:100] }}...
                    </p>
                    <a href="{{ url_for('user.news_detail', news_id=tin._id) }}" 
                       class="btn btn-outline-primary btn-sm">
                        ƒê·ªçc th√™m <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>

<script>
let availableDates = [];
let flatpickrInstance = null;

// Initialize Flatpickr
function initDatePicker() {
    flatpickrInstance = flatpickr("#ngay_di", {
        locale: "vn",
        minDate: "today",
        dateFormat: "Y-m-d",
        placeholder: "Ch·ªçn ng√†y ƒëi...",
        enable: [], // Will be populated with available dates
        onChange: function(selectedDates, dateStr, instance) {
            updatePriceDisplay(dateStr);
        },
        onDayCreate: function(dObj, dStr, fp, dayElem) {
            // Add price info to available dates
            const dateStr = dayElem.dateObj.toISOString().split('T')[0];
            const dateInfo = availableDates.find(d => d.date === dateStr);
            
            if (dateInfo && dateInfo.price > 0) {
                dayElem.innerHTML += `<small class="flatpickr-price">${formatPrice(dateInfo.price)}</small>`;
                dayElem.classList.add('has-price');
            }
        }
    });
}

// Load available dates when route selection changes
function loadAvailableDates() {
    const diemDi = document.getElementById('diem_di').value;
    const diemDen = document.getElementById('diem_den').value;
    
    if (!diemDi || !diemDen) {
        availableDates = [];
        if (flatpickrInstance) {
            flatpickrInstance.set('enable', []);
        }
        return;
    }
    
    console.log('üîç Loading available dates for:', diemDi, '‚Üí', diemDen);
    
    fetch(`/api/available-dates?diem_di=${diemDi}&diem_den=${diemDen}`)
        .then(response => response.json())
        .then(data => {
            console.log('üìÖ Available dates:', data);
            
            if (data.dates && data.dates.length > 0) {
                availableDates = data.dates;
                const enabledDates = data.dates.map(d => d.date);
                
                if (flatpickrInstance) {
                    flatpickrInstance.set('enable', enabledDates);
                    flatpickrInstance.redraw();
                }
                
                showRouteInfo(data.route, data.base_price, data.dates.length);
            } else {
                availableDates = [];
                if (flatpickrInstance) {
                    flatpickrInstance.set('enable', []);
                }
                showRouteInfo(null, 0, 0);
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading dates:', error);
            availableDates = [];
        });
}

// Format price display
function formatPrice(price) {
    if (price === 0) return '';
    return (price / 1000) + 'K';
}

// Update price display when date selected
function updatePriceDisplay(selectedDate) {
    const dateInfo = availableDates.find(d => d.date === selectedDate);
    if (dateInfo) {
        console.log('üí∞ Selected date price:', dateInfo.price, 'VND');
        // You can update UI here to show selected date price
    }
}

// Show route information
function showRouteInfo(routeName, basePrice, tripCount) {
    // Remove existing route info
    const existingInfo = document.querySelector('.route-info-display');
    if (existingInfo) {
        existingInfo.remove();
    }
    
    if (routeName && tripCount > 0) {
        const searchContainer = document.querySelector('.search-container');
        const infoDiv = document.createElement('div');
        infoDiv.className = 'route-info-display mt-3';
        infoDiv.innerHTML = `
            <div class="alert alert-info">
                <h6 class="mb-1"><i class="bi bi-info-circle"></i> ${routeName}</h6>
                <small>T√¨m th·∫•y ${tripCount} chuy·∫øn xe - Gi√° t·ª´ ${basePrice.toLocaleString()} VNƒê</small>
            </div>
        `;
        searchContainer.appendChild(infoDiv);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initDatePicker();
    
    // Listen for route selection changes
    document.getElementById('diem_di').addEventListener('change', loadAvailableDates);
    document.getElementById('diem_den').addEventListener('change', loadAvailableDates);
    
    // Auto-hide alerts
    setTimeout(function() {
        let alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            let bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
});
</script>

<style>
.flatpickr-price {
    display: block;
    font-size: 9px;
    color: #e74c3c;
    font-weight: bold;
    line-height: 1;
    margin-top: 1px;
}

.flatpickr-day.has-price {
    background: linear-gradient(135deg, #fff 60%, #e74c3c 60%);
}

.flatpickr-day.has-price:hover {
    background: linear-gradient(135deg, #f8f9fa 60%, #c0392b 60%);
}

.route-info-display .alert {
    margin-bottom: 0;
    padding: 0.75rem 1rem;
}

.route-info-display .alert h6 {
    color: #0c5460;
    margin: 0;
}
</style>
{% endblock %}
